---
title: "Credit Card"
author: "Henry Siegler"
date: "2022-11-25"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

```{r}
library(tidyverse)
library(here)
library(reshape2)
library(vtable)
```

```{r}
data <- read_csv(here("BankChurners.csv", "BankChurners.csv"))
```

```{r}
data <- data %>% 
  mutate(Exited = case_when(Attrition_Flag == "Existing Customer" ~ 0,
                              Attrition_Flag == "Attrited Customer" ~ 1),
         male = case_when(Gender == "M" ~ 1,
                          Gender == "F" ~ 0),
         ) %>% 
  select(-Naive_Bayes_Classifier_Attrition_Flag_Card_Category_Contacts_Count_12_mon_Dependent_count_Education_Level_Months_Inactive_12_mon_1,
         -Naive_Bayes_Classifier_Attrition_Flag_Card_Category_Contacts_Count_12_mon_Dependent_count_Education_Level_Months_Inactive_12_mon_2,
         -Gender,
         -Attrition_Flag,
         -CLIENTNUM)
```

### Descriptive Statistics
#### Response Variable is Total Transaction Count

```{r}
data %>% 
  select_if(is.numeric) %>% 
  st(out = "return")
```

```{r}
data %>% 
  select_if(is.numeric) %>% 
  cor() %>% 
  round(2) %>% 
  melt() %>% 
  ggplot(aes(Var1, Var2, fill = value)) + 
  geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 8, hjust = 1))+
 coord_fixed()
```
We can see from the correlation matrix that Avg_Open_To_Buy is highly correlated with Credit_Limit, so we will remove Avg_Open_To_Buy because it is redundant to keep it.

```{r}
cor(data$Avg_Open_To_Buy, data$Credit_Limit)
```
```{r}
data <- data %>% 
  select(-Avg_Open_To_Buy)
```



```{r}
cor_matrix <- cor(data %>% 
                    select_if(is.numeric)) %>% 
  round(2)

cor_matrix %>% 
  as.data.frame() %>% 
  select(Total_Trans_Ct) %>% 
  arrange(Total_Trans_Ct)
```

Now we will explore the Total_Trans_Ct variable and its relationship with other correlated variables in our data. 

```{r}
data %>% 
  ggplot(aes(x = Total_Trans_Ct)) + 
  geom_histogram()
```


```{r, fig.width = 5, fig.height = 10}
data %>% 
  ggplot(aes(x = Total_Trans_Ct)) + 
  geom_histogram() + 
  facet_wrap(~ Income_Category, ncol = 1)
```

For all of the income categories, we see a bimodal histogram for the Total_Trans_Ct. For people in the income category of less than $40K, we see that there is a larger spike in the second peak of the histogram compared to the other income categories.

```{r}
data %>% 
  ggplot(aes(x = Total_Trans_Ct)) + 
  geom_histogram() + 
  facet_wrap(~ Exited, nrow = 2)
```

We can see that the Total Transaction Counts for the customers who have have attrited has a unimodal distribution, with the center of the peak being significantly below where most of the Transaction Counts are for the customers who have not attrited. 

```{r}
data %>% 
  group_by(Total_Relationship_Count) %>% 
  summarise(mean(Total_Trans_Ct))

data %>% 
  ggplot(aes(x = as.factor(Total_Relationship_Count),
             y = Total_Trans_Ct)) + 
  geom_bar(stat = "summary",
           fun = mean,
           fill = "dodgerblue")
```


### Data Visualization

```{r}
data %>% 
  ggplot(aes(x = Total_Trans_Amt, y = Total_Trans_Ct, color = as.factor(Exited))) + 
  geom_point(alpha = 0.3) + 
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE)
```

### Splitting the Data

```{r}
set.seed(9)
data$id <- 1:nrow(data)

training_data <- data %>% 
  sample_frac(0.7)

test_data <- data %>% 
  anti_join(training_data, by = 'id')
```


### Linear Regression

Explanatory Variable: Total_Trans_Amt
Response Variable: Total_Trans_Ct

As we can see in the scatter plot, the relationship between total transaction count and total transaction amount is not linear, so we must apply transformations to make the relationship linear. 

```{r}
training_data2 <- training_data %>% 
  mutate(sqrt_total_trans_amt = sqrt(Total_Trans_Amt),
         total_trans_ct_squared = Total_Trans_Ct^2)
```

```{r}
training_data2 %>% 
  ggplot(aes(x = sqrt_total_trans_amt, y = total_trans_ct_squared)) + 
  geom_point()
```

Linearity looks good, equal error variance does not appear to be satisfied. We have increasing variance, so we want to decrease the power of Y. We will first try the square root of Y instead of Y squared.

```{r}
training_data2 <- training_data2 %>% 
  mutate(sqrt_total_trans_ct = sqrt(Total_Trans_Ct))
```

```{r}
training_data2 %>% 
  ggplot(aes(x = sqrt_total_trans_amt, y = sqrt_total_trans_ct)) + 
  geom_point()
```

Equal error variance looks like it is satisfied, however linearity does not look ideal. Therefore, we want to try to find a transformation for Y that is between Y^0.5 and Y^2. 

We will raise total transaction count to the power of 0.8 because this transforming keeps the relationship fairly linear and maintains fairly equal error variance.

```{r}
training_data2 <- training_data2 %>% 
  mutate(total_trans_ct_transformed = Total_Trans_Ct^0.8)
```

```{r}
training_data2 %>% 
  ggplot(aes(x = sqrt_total_trans_amt, y = total_trans_ct_transformed)) + 
  geom_point()
```

Therefore our final transformations for simple linear regression between Total_Trans_Amt and Total_Trans_Ct are:

X' = $\sqrt{Total\_Trans\_Amt}$
Y' = $Total\_Trans\_Ct^{0.8}$











